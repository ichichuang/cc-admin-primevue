name: ðŸ›¡ï¸ cc-admin æ¡†æž¶ä¿æŠ¤ç›‘æŽ§

on:
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹ (UTC+8 = UTC+0çš„1ç‚¹)
    - cron: '0 1 * * 1'
  workflow_dispatch:
    inputs:
      search_intensity:
        description: 'æœç´¢å¼ºåº¦'
        required: false
        default: 'standard'
        type: choice
        options:
          - light
          - standard
          - intensive

env:
  # cc-admin æ¡†æž¶ç‰¹å¾
  FRAMEWORK_NAME: 'cc-admin'
  AUTHOR: 'chichuang'
  GITHUB_USERNAME: 'ichichuang'
  REPO_NAME: 'cc-admin'

  # ç‹¬ç‰¹æŠ€æœ¯æ ˆç»„åˆ
  TECH_STACK_SIGNATURE: 'Vue 3.5 TypeScript 5 UnoCSS 0.66 pnpm 10.12.4'

jobs:
  cc-admin-protection:
    runs-on: ubuntu-latest
    name: ðŸ” cc-admin æ¡†æž¶ç›‘æŽ§

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” æ£€æµ‹ç‰ˆæƒæ ‡è¯†æŠ„è¢­
        id: copyright_check
        run: |
          echo 'ðŸ” æ£€æµ‹ç‰ˆæƒæ ‡è¯†æŠ„è¢­...'

          # cc-admin ç‰¹æœ‰çš„ç‰ˆæƒæ ‡è¯† - æ›´ç²¾ç¡®çš„æœç´¢å…³é”®è¯
          COPYRIGHT_SIGNATURES=(
            '@copyright Copyright (c) 2025 chichuang'
            'cc-admin ä¼ä¸šçº§åŽå°ç®¡ç†æ¡†æž¶'
            'æœ¬æ–‡ä»¶ä¸º chichuang åŽŸåˆ›'
            'ç¦æ­¢æ“…è‡ªåˆ é™¤ç½²åæˆ–ç”¨äºŽå•†ä¸šç”¨é€”'
            'chichuang cc-admin'
            'cc-admin-FRAMEWORK-CHICHUANG-2025'
            'chichuang åŽŸåˆ›'
            # ç§»é™¤å®¹æ˜“è¯¯æŠ¥çš„å…³é”®è¯
            # 'cc-admin v1.0' - è¿™ä¸ªå…³é”®è¯å¤ªé€šç”¨ï¼Œå®¹æ˜“è¯¯æŠ¥
          )

          FOUND_VIOLATIONS=''

          for signature in "${COPYRIGHT_SIGNATURES[@]}"; do
            echo "ðŸ” æœç´¢ç‰ˆæƒæ ‡è¯†: $signature"

            # ä½¿ç”¨GitHub APIæœç´¢
            encoded_query=$(echo "$signature -user:$GITHUB_USERNAME -repo:$REPO_NAME" | sed 's/ /%20/g' | sed 's/:/%3A/g')

            response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/search/code?q=$encoded_query&per_page=10")

            total_count=$(echo "$response" | jq -r '.total_count // 0')

            if [ "$total_count" -gt 0 ]; then
              echo "âš ï¸ å‘çŽ°ç‰ˆæƒä¾µçŠ¯: $total_count ä¸ªåŒ¹é…é¡¹"

              # æå–ä»“åº“ä¿¡æ¯
              echo "$response" | jq -r '.items[]? | "ðŸš¨ ç‰ˆæƒä¾µçŠ¯: \(.repository.full_name) - æ–‡ä»¶: \(.name) - \(.html_url)"' >> copyright_violations.txt
              FOUND_VIOLATIONS='true'
            fi

            sleep 2
          done

          echo "found_violations=$FOUND_VIOLATIONS" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ æ£€æµ‹æ–‡ä»¶ç»“æž„æŠ„è¢­
        id: structure_check
        run: |
          echo 'ðŸ—ï¸ æ£€æµ‹æ–‡ä»¶ç»“æž„æŠ„è¢­...'

          # cc-admin ç‹¬ç‰¹çš„æ–‡ä»¶ç»“æž„æ¨¡å¼ - æ›´ç²¾ç¡®çš„ç»„åˆ
          STRUCTURE_PATTERNS=(
            'src/stores/modules index.ts chichuang'
            'src/api/modules index.ts chichuang'
            'src/router/modules index.ts chichuang'
            'unocss/rules unocss/shortcuts chichuang'
            'scripts/ chichuang cc-admin'
            'src/hooks/modules chichuang'
            'src/common/modules chichuang'
            'src/locales/modules chichuang'
            'src/mock/modules chichuang'
            # æ·»åŠ æ›´ç‹¬ç‰¹çš„ç»„åˆ
            'cc-admin ä¼ä¸šçº§åŽå°ç®¡ç†æ¡†æž¶ chichuang'
            'Vue 3.5+ TypeScript 5+ Vite 7+ chichuang'
            'UnoCSS 0.66 ä¼ä¸šçº§åŽå° chichuang'
          )

          STRUCTURE_VIOLATIONS=''

          for pattern in "${STRUCTURE_PATTERNS[@]}"; do
            echo "ðŸ” æœç´¢ç»“æž„æ¨¡å¼: $pattern"

            encoded_query=$(echo "$pattern -user:$GITHUB_USERNAME" | sed 's/ /%20/g')

            response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/search/code?q=$encoded_query&per_page=5")

            total_count=$(echo "$response" | jq -r '.total_count // 0')

            if [ "$total_count" -gt 0 ]; then
              echo "âš ï¸ å‘çŽ°ç»“æž„ç›¸ä¼¼: $total_count ä¸ªåŒ¹é…é¡¹"
              echo "$response" | jq -r '.items[]? | "ðŸ“ ç»“æž„ç›¸ä¼¼: \(.repository.full_name) - \(.html_url)"' >> structure_similarities.txt
              STRUCTURE_VIOLATIONS='true'
            fi

            sleep 2
          done

          echo "structure_violations=$STRUCTURE_VIOLATIONS" >> $GITHUB_OUTPUT

      - name: âš¡ æ£€æµ‹æŠ€æœ¯æ ˆæŠ„è¢­
        id: techstack_check
        run: |
          echo 'âš¡ æ£€æµ‹æŠ€æœ¯æ ˆæŠ„è¢­...'

          # cc-admin ç‰¹æœ‰çš„æŠ€æœ¯æ ˆç»„åˆ - æ›´ç²¾ç¡®çš„æŸ¥è¯¢
          TECHSTACK_QUERIES=(
            'Vue 3.5 TypeScript 5 UnoCSS Vite chichuang'
            'Pinia 3 Alova 3 Vue I18n 10 chichuang'
            'pnpm 10.12.4 Vue3 admin chichuang'
            'UnoCSS 0.66 ä¼ä¸šçº§åŽå° chichuang'
            'Vue 3.5+ TypeScript 5+ Vite 7+ chichuang'
            'cc-admin ä¼ä¸šçº§åŽå°ç®¡ç†æ¡†æž¶ chichuang'
            # æ·»åŠ æ›´ç‹¬ç‰¹çš„ç»„åˆ
            'chichuang cc-admin ä¼ä¸šçº§åŽå°ç®¡ç†æ¡†æž¶'
            'chichuang Vue 3.5 TypeScript 5 UnoCSS'
            'chichuang Pinia 3 Alova 3 Vue I18n 10'
          )

          TECHSTACK_MATCHES=''

          for query in "${TECHSTACK_QUERIES[@]}"; do
            echo "ðŸ” æœç´¢æŠ€æœ¯æ ˆ: $query"

            encoded_query=$(echo "$query -user:$GITHUB_USERNAME" | sed 's/ /%20/g')

            response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/search/repositories?q=$encoded_query&per_page=5")

            total_count=$(echo "$response" | jq -r '.total_count // 0')

            if [ "$total_count" -gt 0 ]; then
              echo "ðŸ“Š å‘çŽ°ç›¸ä¼¼æŠ€æœ¯æ ˆ: $total_count ä¸ªä»“åº“"
              echo "$response" | jq -r '.items[]? | "ðŸ”§ æŠ€æœ¯æ ˆç›¸ä¼¼: \(.full_name) - Stars: \(.stargazers_count) - \(.html_url)"' >> techstack_matches.txt
              TECHSTACK_MATCHES='true'
            fi

            sleep 2
          done

          echo "techstack_matches=$TECHSTACK_MATCHES" >> $GITHUB_OUTPUT

      - name: ðŸ“Š åˆ†æž Fork å’Œ Star æƒ…å†µ
        id: analyze_engagement
        run: |
          echo 'ðŸ“Š åˆ†æž Fork å’Œ Star æƒ…å†µ...'

          # èŽ·å–ä»“åº“ç»Ÿè®¡ä¿¡æ¯
          repo_info=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$GITHUB_USERNAME/$REPO_NAME")

          star_count=$(echo "$repo_info" | jq -r '.stargazers_count // 0')
          fork_count=$(echo "$repo_info" | jq -r '.forks_count // 0')

          echo "â­ å½“å‰ Stars: $star_count"
          echo "ðŸ´ å½“å‰ Forks: $fork_count"

          # èŽ·å–æœ€è¿‘çš„ forks
          forks_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$GITHUB_USERNAME/$REPO_NAME/forks?sort=created&direction=desc&per_page=5")

          echo "$forks_response" | jq -r '.[]? | "ðŸ´ æœ€è¿‘Fork: \(.full_name) - åˆ›å»º: \(.created_at) - \(.html_url)"' > recent_forks.txt

          echo "star_count=$star_count" >> $GITHUB_OUTPUT
          echo "fork_count=$fork_count" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ ç”Ÿæˆ cc-admin ä¿æŠ¤æŠ¥å‘Š
        run: |
          echo 'ðŸŽ¯ ç”Ÿæˆ cc-admin ä¿æŠ¤æŠ¥å‘Š...'

          # åˆ›å»ºè¯¦ç»†çš„ç›‘æŽ§æŠ¥å‘Š
          cat > cc_admin_protection_report.md << EOF
          # ðŸ›¡ï¸ cc-admin æ¡†æž¶ä¿æŠ¤ç›‘æŽ§æŠ¥å‘Š

          **ç›‘æŽ§æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          **æ¡†æž¶åç§°**: cc-admin ä¼ä¸šçº§åŽå°ç®¡ç†æ¡†æž¶
          **ä½œè€…**: chichuang
          **ä»“åº“**: $GITHUB_USERNAME/$REPO_NAME

          ## ðŸ“ˆ é¡¹ç›®ç»Ÿè®¡
          - â­ **Stars**: ${{ steps.analyze_engagement.outputs.star_count }}
          - ðŸ´ **Forks**: ${{ steps.analyze_engagement.outputs.fork_count }}

          ## ðŸš¨ ç‰ˆæƒä¾µçŠ¯æ£€æµ‹
          $(if [ -f "copyright_violations.txt" ] && [ -s "copyright_violations.txt" ]; then
            echo "**âš ï¸ å‘çŽ°ç‰ˆæƒä¾µçŠ¯è¡Œä¸º:**"
            cat copyright_violations.txt
          else
            echo "âœ… æœªå‘çŽ°ç‰ˆæƒä¾µçŠ¯è¡Œä¸º"
          fi)

          ## ðŸ—ï¸ æ–‡ä»¶ç»“æž„ç›¸ä¼¼åº¦
          $(if [ -f "structure_similarities.txt" ] && [ -s "structure_similarities.txt" ]; then
            echo "**ðŸ“ å‘çŽ°ç»“æž„ç›¸ä¼¼é¡¹ç›®:**"
            cat structure_similarities.txt
          else
            echo "âœ… æœªå‘çŽ°ç»“æž„æŠ„è¢­"
          fi)

          ## âš¡ æŠ€æœ¯æ ˆç›¸ä¼¼åº¦
          $(if [ -f "techstack_matches.txt" ] && [ -s "techstack_matches.txt" ]; then
            echo "**ðŸ”§ å‘çŽ°ç›¸ä¼¼æŠ€æœ¯æ ˆé¡¹ç›®:**"
            cat techstack_matches.txt
          else
            echo "âœ… æŠ€æœ¯æ ˆç»„åˆç‹¬ç‰¹"
          fi)

          ## ðŸ´ æœ€è¿‘ Fork æƒ…å†µ
          $(if [ -f "recent_forks.txt" ]; then cat recent_forks.txt; else echo "æš‚æ— æ–°çš„Fork"; fi)

          ## ðŸ›¡ï¸ ä¿æŠ¤å»ºè®®
          $(if [[ "${{ steps.copyright_check.outputs.found_violations }}" == "true" ]]; then
            echo "### ðŸš¨ ç´§æ€¥æŽªæ–½"
            echo "- ðŸ“§ ç«‹å³è”ç³»ä¾µæƒæ–¹è¦æ±‚åˆ é™¤æˆ–æ ‡æ³¨åŽŸä½œè€…"
            echo "- ðŸ“ è€ƒè™‘å‘é€ DMCA åˆ é™¤é€šçŸ¥"
            echo "- ðŸ”’ åœ¨ä»£ç ä¸­æ·»åŠ æ›´å¤šç‰ˆæƒä¿æŠ¤æŽªæ–½"
            echo ""
          fi)

          ### ðŸ“‹ å¸¸è§„å»ºè®®
          - ðŸ” å®šæœŸç›‘æŽ§ä»£ç ä½¿ç”¨æƒ…å†µ
          - ðŸ“„ å®Œå–„å¼€æºåè®®å’Œä½¿ç”¨æ¡æ¬¾
          - ðŸ·ï¸ åœ¨å…³é”®æ–‡ä»¶ä¸­å¢žåŠ æ›´å¤šæ ‡è¯†ç¬¦
          - ðŸ“± è€ƒè™‘è®¾ç½®æ›´é¢‘ç¹çš„ç›‘æŽ§é¢‘çŽ‡

          ---
          *cc-admin æ¡†æž¶ä¿æŠ¤ç³»ç»Ÿ v1.0 - ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          EOF

      - name: ðŸš¨ åˆ›å»ºä¸¥é‡é—®é¢˜ Issue
        if: steps.copyright_check.outputs.found_violations == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            if (fs.existsSync('cc_admin_protection_report.md')) {
              reportContent = fs.readFileSync('cc_admin_protection_report.md', 'utf8');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ cc-admin ç‰ˆæƒä¾µçŠ¯è­¦æŠ¥ - ${new Date().toISOString().split('T')[0]}`,
              body: reportContent,
              labels: ['urgent', 'copyright', 'security', 'protection']
            });

      - name: ðŸ“§ å‘é€é‚®ä»¶é€šçŸ¥
        if: steps.copyright_check.outputs.found_violations == 'true' || steps.structure_check.outputs.structure_violations == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ðŸš¨ cc-admin æ¡†æž¶ä¿æŠ¤è­¦æŠ¥ - å‘çŽ°å¯ç–‘æŠ„è¢­è¡Œä¸º'
          body: file://cc_admin_protection_report.md
          to: ${{ secrets.NOTIFICATION_EMAIL }}

      - name: ðŸ“ ä¿å­˜ç›‘æŽ§ç»“æžœ
        uses: actions/upload-artifact@v4
        with:
          name: cc-admin-protection-report-${{ github.run_number }}
          path: |
            cc_admin_protection_report.md
            copyright_violations.txt
            structure_similarities.txt
            techstack_matches.txt
            recent_forks.txt
          retention-days: 90
